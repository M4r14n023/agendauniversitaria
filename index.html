<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi agenda Universitaria</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #1a4d2e;
      --primary-light: #2d6a4f;
      --secondary: #8b4513;
      --background: #faf8f5;
      --surface: #ffffff;
      --text: #2c2c2c;
      --text-muted: #6b6b6b;
      --border: #d4cfc4;
      --accent: #c17817;
      --warning: #d97706;
      --error: #dc2626;
      --success: #059669;
      
      --serif: 'Crimson Pro', serif;
      --sans: 'IBM Plex Sans', sans-serif;
      
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    body {
      font-family: var(--sans);
      background: var(--background);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    
    h1, h2, h3, h4 {
      font-family: var(--serif);
      font-weight: 700;
      line-height: 1.2;
    }
    
    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    /* Header */
    .app-header {
      background: var(--surface);
      border-bottom: 2px solid var(--primary);
      padding: 1.5rem 0;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-sm);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .app-title {
      font-size: 2rem;
      color: var(--primary);
      letter-spacing: -0.5px;
    }
    
    .header-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    /* B√∫squeda global */
    .search-bar {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 1rem 0;
    }
    
    .search-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: var(--sans);
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    /* Botones */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-family: var(--sans);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-sm);
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-light);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 2px solid var(--border);
    }
    
    .btn-secondary:hover {
      border-color: var(--primary);
      background: var(--background);
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
    }
    
    .tab {
      padding: 1rem 1.5rem;
      background: none;
      border: none;
      font-family: var(--serif);
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .tab:hover {
      color: var(--primary);
    }
    
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      animation: fadeIn 0.2s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      padding: 1.5rem;
      border-bottom: 2px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 1.5rem;
      color: var(--primary);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0.25rem 0.5rem;
      line-height: 1;
    }
    
    .modal-close:hover {
      color: var(--text);
    }
    
    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }
    
    .modal-footer {
      padding: 1.5rem;
      border-top: 2px solid var(--border);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }
    
    /* Stepper */
    .stepper {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
      position: relative;
    }
    
    .stepper::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--border);
      z-index: 0;
    }
    
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      position: relative;
      z-index: 1;
      flex: 1;
    }
    
    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--surface);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.3s;
    }
    
    .step.active .step-number {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .step.completed .step-number {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    
    .step-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-align: center;
    }
    
    .step.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }
    
    /* Form */
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text);
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-family: var(--sans);
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-checkbox {
      margin-right: 0.5rem;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    /* Vista Semana */
    .week-view {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
    }
    
    .week-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .week-time-column {
      border-right: 2px solid var(--border);
      background: var(--background);
    }
    
    .week-days-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      position: relative;
    }
    
    .week-header {
      background: var(--primary);
      color: white;
      padding: 1rem 0.5rem;
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .week-header:first-child {
      background: var(--surface);
      color: var(--text);
    }
    
    .time-slot {
      height: 60px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    .time-slot:last-child {
      border-bottom: none;
    }
    
    .day-column {
      position: relative;
      border-right: 1px solid var(--border);
      background: var(--surface);
    }
    
    .day-column:last-child {
      border-right: none;
    }
    
    .day-column-bg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    
    .hour-line {
      height: 60px;
      border-bottom: 1px solid var(--border);
    }
    
    .hour-line:last-child {
      border-bottom: none;
    }
    
    .session-block {
      position: absolute;
      left: 4px;
      right: 4px;
      background: var(--primary-light);
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid var(--primary);
      overflow: hidden;
      z-index: 1;
    }
    
    .session-block:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-md);
    }
    
    .session-block.teoria {
      background: linear-gradient(135deg, #2d6a4f 0%, #1a4d2e 100%);
    }
    
    .session-block.practica {
      background: linear-gradient(135deg, #8b4513 0%, #654321 100%);
    }
    
    .session-block.gym {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      border-left-color: #f59e0b;
    }
    
    .session-block.tenis {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
      border-left-color: #06b6d4;
    }
    
    .session-block.clase_tenis {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      border-left-color: #8b5cf6;
    }
    
    .session-block.otra {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
      border-left-color: #f472b6;
    }
    
    .session-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .session-time {
      font-size: 0.75rem;
      opacity: 0.9;
    }
    
    /* Vista Mes */
    .month-view {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
    }
    
    .month-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .month-title {
      font-size: 1.5rem;
      color: var(--primary);
    }
    
    .month-nav {
      display: flex;
      gap: 0.5rem;
    }
    
    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .month-day-header {
      background: var(--primary);
      color: white;
      padding: 0.75rem 0.5rem;
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .month-day {
      background: var(--surface);
      padding: 0.5rem;
      min-height: 100px;
      max-height: 120px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .month-day:hover {
      background: var(--background);
    }
    
    .month-day.other-month {
      opacity: 0.4;
    }
    
    .month-day-number {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.5rem;
    }
    
    .month-day-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
      display: inline-block;
      margin: 2px;
    }
    
    .month-event {
      background: var(--accent);
      color: white;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-size: 0.7rem;
      margin-top: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
    }
    
    /* Vista Lista */
    .list-view {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
    }
    
    .list-filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .list-item {
      padding: 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .list-item:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-sm);
    }
    
    .list-item-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.5rem;
    }
    
    .list-item-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--primary);
      font-family: var(--serif);
    }
    
    .list-item-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .badge-teoria {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-practica {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-examen {
      background: #f8d7da;
      color: #721c24;
    }
    
    .badge-gym {
      background: #fed7aa;
      color: #9a3412;
    }
    
    .badge-tenis {
      background: #cffafe;
      color: #164e63;
    }
    
    .badge-clase_tenis {
      background: #e9d5ff;
      color: #581c87;
    }
    
    .badge-otra {
      background: #fce7f3;
      color: #9f1239;
    }
    
    .list-item-details {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    /* Vista Estad√≠sticas */
    .stats-view {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    
    .stat-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
      border-top: 4px solid var(--primary);
    }
    
    .stat-title {
      font-size: 0.9rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      font-family: var(--serif);
      margin-bottom: 0.5rem;
    }
    
    .stat-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    .stat-list {
      margin-top: 1rem;
    }
    
    .stat-list-item {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stat-list-item:last-child {
      border-bottom: none;
    }
    
    /* Panel lateral */
    .side-panel {
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      width: 400px;
      max-width: 90vw;
      background: var(--surface);
      box-shadow: var(--shadow-lg);
      transform: translateX(100%);
      transition: transform 0.3s;
      z-index: 1001;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .side-panel.open {
      transform: translateX(0);
    }
    
    .side-panel-header {
      padding: 1.5rem;
      border-bottom: 2px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 2;
      flex-shrink: 0;
    }
    
    .side-panel-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }
    
    .side-panel-section {
      margin-bottom: 2rem;
    }
    
    .side-panel-section-title {
      font-size: 1.1rem;
      color: var(--primary);
      margin-bottom: 1rem;
      font-family: var(--serif);
    }
    
    /* Alertas */
    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      gap: 0.75rem;
      align-items: start;
    }
    
    .alert-warning {
      background: #fef3c7;
      color: #92400e;
      border-left: 4px solid var(--warning);
    }
    
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid var(--error);
    }
    
    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border-left: 4px solid var(--primary);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .app-title {
        font-size: 1.5rem;
      }
      
      .week-grid {
        grid-template-columns: 60px 1fr;
        font-size: 0.8rem;
      }
      
      .time-slot {
        height: 50px;
        font-size: 0.75rem;
      }
      
      .hour-line {
        height: 50px;
      }
      
      .session-block {
        font-size: 0.75rem;
        padding: 0.35rem;
      }
      
      .session-name {
        font-size: 0.8rem;
      }
      
      .session-time {
        font-size: 0.65rem;
      }
      
      .month-grid {
        gap: 2px;
      }
      
      .month-day {
        min-height: 70px;
        max-height: 90px;
        padding: 0.25rem;
      }
      
      .stats-view {
        grid-template-columns: 1fr;
      }
      
      .modal {
        margin: 0;
        border-radius: 0;
        max-height: 100vh;
      }
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .item-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .item-entry {
      padding: 0.75rem;
      background: var(--background);
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .item-entry-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .activity-type-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .activity-type-card {
      padding: 1.5rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--surface);
    }
    
    .activity-type-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .activity-type-card.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }
    
    .activity-type-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    .activity-type-label {
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .multi-select-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .multi-select-item {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      background: var(--surface);
    }
    
    .multi-select-item:hover {
      border-color: var(--primary);
    }
    
    .multi-select-item.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }
    
    .session-icon {
      margin-right: 0.25rem;
    }
    
    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    
    .btn-danger {
      background: var(--error);
      color: white;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ============ TIPOS Y MODELO DE DATOS ============
    
    // Modelo normalizado
    const createEmptyTerm = () => ({
      id: 'term-1',
      nombre: 'Cuatrimestre 1 2025',
      startDate: '2025-03-10',
      endDate: '2025-07-11',
      timezone: 'America/Argentina/Buenos_Aires'
    });

    const createEmptyCourse = () => ({
      id: `course-${Date.now()}`,
      nombre: '',
      email: '',
      reunionDia: null,
      reunionHora: null,
      notas: ''
    });

    const createEmptyWeeklySession = () => ({
      id: `session-${Date.now()}`,
      termId: 'term-1',
      courseId: '',
      modalidad: 'practica',
      dayOfWeek: 1,
      startTime: '08:00',
      endTime: '10:00',
      docente: '',
      aula: '',
      obligatoria: true,
      numeroComision: ''
    });

    const createEmptyEvent = () => ({
      id: `event-${Date.now()}`,
      termId: 'term-1',
      courseId: '',
      eventualType: 'examen',
      examType: 'Parcial',
      dateISO: new Date().toISOString(),
      notes: '',
      status: 'confirmed'
    });

    const createEmptyExtracurricularSession = () => ({
      id: `extra-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      termId: 'term-1',
      kind: 'gym',
      dayOfWeek: 1,
      startTime: '08:00',
      endTime: '09:00',
      startDate: new Date().toISOString().split('T')[0], // YYYY-MM-DD
      title: 'GYM',
      colorKey: 'gym',
      metadata: {
        muscleGroups: [],
        customMuscleGroup: '',
        intensity: '',
        studentLevel: '',
        modality: '',
        studentCount: null,
        note: '',
        otherDescription: ''
      }
    });

    // ============ UTILIDADES ============
    
    const DAYS = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie'];
    const DAYS_FULL = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

    function getDayName(dayNum) {
      return DAYS_FULL[dayNum - 1] || '';
    }

    function formatTime(time) {
      return time ? time.substring(0, 5) : '';
    }

    function parseTime(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      return h * 60 + m;
    }

    function getMonthName(month) {
      const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      return months[month];
    }
    
    function getExamTypeName(event) {
      if (event.examType === 'Otro' && event.customExamType) {
        return event.customExamType;
      }
      return event.examType || '';
    }
    
    function getActivityIcon(kind) {
      const icons = {
        gym: 'üèãÔ∏è',
        tenis: 'üéæ',
        clase_tenis: 'üßë‚Äçüè´',
        otra: '‚ú≥Ô∏è'
      };
      return icons[kind] || '‚ú≥Ô∏è';
    }
    
    function getActivityTitle(activity) {
      const { kind, metadata } = activity;
      
      if (kind === 'gym') {
        const groups = metadata.muscleGroups || [];
        if (groups.length > 0) {
          const display = groups.slice(0, 2).join(' + ');
          return groups.length > 2 ? `GYM (${display}...)` : `GYM (${display})`;
        }
        return 'GYM';
      }
      
      if (kind === 'tenis') {
        return 'Tenis';
      }
      
      if (kind === 'clase_tenis') {
        if (metadata.modality) {
          return `Clase Tenis (${metadata.modality})`;
        }
        return 'Clase Tenis';
      }
      
      if (kind === 'otra') {
        // Intentar usar el campo otherDescription como etiqueta
        const label = metadata.otherDescription ? metadata.otherDescription.substring(0, 20) : '';
        return label ? `Otra: ${label}` : 'Otra';
      }
      
      return activity.title || 'Actividad';
    }

    function getDaysInMonth(year, month) {
      return new Date(year, month + 1, 0).getDate();
    }

    function getFirstDayOfMonth(year, month) {
      const day = new Date(year, month, 1).getDay();
      return day === 0 ? 7 : day; // Convertir domingo de 0 a 7
    }

    function isSameDay(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
             date1.getMonth() === date2.getMonth() &&
             date1.getDate() === date2.getDate();
    }

    // Generar ocurrencias de una sesi√≥n semanal
    function generateSessionOccurrences(session, term) {
      const occurrences = [];
      const start = new Date(term.startDate);
      const end = new Date(term.endDate);
      
      let current = new Date(start);
      
      // Avanzar hasta el primer d√≠a que coincida
      while (current <= end) {
        const currentDay = current.getDay() === 0 ? 7 : current.getDay();
        if (currentDay === session.dayOfWeek) {
          occurrences.push(new Date(current));
        }
        current.setDate(current.getDate() + 1);
      }
      
      return occurrences;
    }

    // Detectar conflictos
    function detectConflicts(sessions, courses) {
      const conflicts = [];
      
      for (let i = 0; i < sessions.length; i++) {
        for (let j = i + 1; j < sessions.length; j++) {
          const s1 = sessions[i];
          const s2 = sessions[j];
          
          if (s1.dayOfWeek === s2.dayOfWeek) {
            const start1 = parseTime(s1.startTime);
            const end1 = parseTime(s1.endTime);
            const start2 = parseTime(s2.startTime);
            const end2 = parseTime(s2.endTime);
            
            // Superposici√≥n
            if (start1 < end2 && start2 < end1) {
              const course1 = courses.find(c => c.id === s1.courseId);
              const course2 = courses.find(c => c.id === s2.courseId);
              
              conflicts.push({
                type: 'overlap',
                session1: { ...s1, courseName: course1?.nombre },
                session2: { ...s2, courseName: course2?.nombre }
              });
            }
            // Clases pegadas (gap = 0)
            else if (end1 === start2 || end2 === start1) {
              const course1 = courses.find(c => c.id === s1.courseId);
              const course2 = courses.find(c => c.id === s2.courseId);
              
              conflicts.push({
                type: 'no-gap',
                session1: { ...s1, courseName: course1?.nombre },
                session2: { ...s2, courseName: course2?.nombre }
              });
            }
          }
        }
      }
      
      return conflicts;
    }

    // ============ IMPORTACI√ìN LEGADO ============
    
    // Validar choque de una nueva actividad extracurricular
    function validateExtracurricularConflict(newActivity, allWeeklySessions, allExtras, courses, editingId = null) {
      const conflicts = [];
      const newStart = parseTime(newActivity.startTime);
      const newEnd = parseTime(newActivity.endTime);
      
      // Verificar contra sesiones acad√©micas
      allWeeklySessions.forEach(session => {
        if (session.dayOfWeek === newActivity.dayOfWeek) {
          const start = parseTime(session.startTime);
          const end = parseTime(session.endTime);
          
          if (newStart < end && newEnd > start) {
            const course = courses.find(c => c.id === session.courseId);
            conflicts.push({
              name: course?.nombre || 'Clase',
              startTime: session.startTime,
              endTime: session.endTime,
              type: 'academic'
            });
          }
        }
      });
      
      // Verificar contra otras actividades extracurriculares
      allExtras.forEach(extra => {
        // Ignorar si es la misma actividad (edici√≥n)
        if (editingId && extra.id === editingId) return;
        
        if (extra.dayOfWeek === newActivity.dayOfWeek) {
          const start = parseTime(extra.startTime);
          const end = parseTime(extra.endTime);
          
          if (newStart < end && newEnd > start) {
            conflicts.push({
              name: getActivityTitle(extra),
              startTime: extra.startTime,
              endTime: extra.endTime,
              type: 'extracurricular'
            });
          }
        }
      });
      
      return conflicts;
    }
    
    // ============ IMPORTACI√ìN LEGADO ============
    
    function importLegacyData(legacyArray) {
      const courses = [];
      const weeklySessions = [];
      const events = [];
      const courseMap = new Map();
      
      legacyArray.forEach(item => {
        if (item.type === 'habitual') {
          // Buscar o crear curso
          let course = courseMap.get(item.catedra);
          if (!course) {
            course = {
              id: `course-${Date.now()}-${Math.random()}`,
              nombre: item.catedra || item.category,
              email: item.contact || '',
              notas: ''
            };
            courseMap.set(item.catedra, course);
            courses.push(course);
          }
          
          // Crear sesi√≥n semanal
          const session = {
            id: item.id || `session-${Date.now()}-${Math.random()}`,
            termId: 'term-1',
            courseId: course.id,
            modalidad: item.modalidad || 'teoria',
            dayOfWeek: item.dayOfWeek || 1,
            startTime: item.startTime || '08:00',
            endTime: item.endTime || '10:00',
            docente: item.docente || '',
            aula: item.aula || '',
            obligatoria: item.obligatoria !== false,
            numeroComision: item.detail || ''
          };
          weeklySessions.push(session);
          
        } else if (item.type === 'eventual' && item.eventualType === 'examen') {
          // Buscar o crear curso
          let course = courseMap.get(item.subject);
          if (!course) {
            course = {
              id: `course-${Date.now()}-${Math.random()}`,
              nombre: item.subject,
              email: '',
              notas: ''
            };
            courseMap.set(item.subject, course);
            courses.push(course);
          }
          
          // Crear evento
          const event = {
            id: item.id || `event-${Date.now()}-${Math.random()}`,
            termId: 'term-1',
            courseId: course.id,
            eventualType: 'examen',
            examType: item.examType || 'Parcial',
            dateISO: item.examDate || item.date,
            notes: item.detail || '',
            status: item.status || 'confirmed'
          };
          events.push(event);
        }
      });
      
      return { courses, weeklySessions, events };
    }

    // Exportar a formato legado
    function exportToLegacyFormat(data) {
      const { term, courses, weeklySessions, events } = data;
      const legacy = [];
      
      weeklySessions.forEach(session => {
        const course = courses.find(c => c.id === session.courseId);
        legacy.push({
          type: 'habitual',
          id: session.id,
          category: course?.nombre || '',
          detail: session.numeroComision,
          dayOfWeek: session.dayOfWeek,
          startTime: session.startTime,
          endTime: session.endTime,
          contact: course?.email || '',
          modalidad: session.modalidad,
          catedra: course?.nombre || '',
          docente: session.docente,
          aula: session.aula,
          obligatoria: session.obligatoria,
          fechaInicioTeoria: term.startDate,
          fechaFinTeoria: term.endDate
        });
      });
      
      events.forEach(event => {
        const course = courses.find(c => c.id === event.courseId);
        legacy.push({
          type: 'eventual',
          id: event.id,
          eventualType: event.eventualType,
          subject: course?.nombre || '',
          examType: event.examType,
          examDate: event.dateISO,
          date: event.dateISO,
          detail: event.notes,
          status: event.status
        });
      });
      
      return legacy;
    }

    // ============ DATOS DEMO ============
    
    function getDemoData() {
      const term = createEmptyTerm();
      
      const courses = [
        { id: 'c1', nombre: 'An√°lisis Matem√°tico I', email: 'analisis@fi.uba.ar', notas: 'C√°tedra Fern√°ndez' },
        { id: 'c2', nombre: '√Ålgebra y Geometr√≠a Anal√≠tica', email: 'algebra@fi.uba.ar', notas: '' },
        { id: 'c3', nombre: 'Qu√≠mica', email: 'quimica@fi.uba.ar', notas: '' },
        { id: 'c4', nombre: 'F√≠sica I', email: 'fisica@fi.uba.ar', notas: 'C√°tedra L√≥pez' }
      ];
      
      const weeklySessions = [
        { id: 's1', termId: 'term-1', courseId: 'c1', modalidad: 'teoria', dayOfWeek: 1, startTime: '08:00', endTime: '11:00', docente: 'Prof. Fern√°ndez', aula: 'Aula 203', obligatoria: true, numeroComision: 'Comisi√≥n 1' },
        { id: 's2', termId: 'term-1', courseId: 'c1', modalidad: 'practica', dayOfWeek: 3, startTime: '14:00', endTime: '17:00', docente: 'Aux. Garc√≠a', aula: 'Lab 5', obligatoria: true, numeroComision: 'Comisi√≥n 1A' },
        { id: 's3', termId: 'term-1', courseId: 'c2', modalidad: 'teoria', dayOfWeek: 2, startTime: '09:00', endTime: '12:00', docente: 'Prof. Mart√≠nez', aula: 'Aula 105', obligatoria: true, numeroComision: '' },
        { id: 's4', termId: 'term-1', courseId: 'c2', modalidad: 'practica', dayOfWeek: 4, startTime: '15:00', endTime: '18:00', docente: 'Aux. Rodr√≠guez', aula: 'Lab 3', obligatoria: true, numeroComision: 'Grupo 2' },
        { id: 's5', termId: 'term-1', courseId: 'c3', modalidad: 'teoria', dayOfWeek: 1, startTime: '14:00', endTime: '16:00', docente: 'Prof. Silva', aula: 'Aula 301', obligatoria: false, numeroComision: '' },
        { id: 's6', termId: 'term-1', courseId: 'c3', modalidad: 'practica', dayOfWeek: 5, startTime: '10:00', endTime: '13:00', docente: 'Aux. Torres', aula: 'Lab Qu√≠mica', obligatoria: true, numeroComision: 'Grupo A' },
        { id: 's7', termId: 'term-1', courseId: 'c4', modalidad: 'teoria', dayOfWeek: 3, startTime: '08:00', endTime: '10:00', docente: 'Prof. L√≥pez', aula: 'Anfiteatro', obligatoria: true, numeroComision: '' },
        { id: 's8', termId: 'term-1', courseId: 'c4', modalidad: 'practica', dayOfWeek: 5, startTime: '14:00', endTime: '17:00', docente: 'Aux. P√©rez', aula: 'Lab F√≠sica', obligatoria: true, numeroComision: 'Comisi√≥n 3' }
      ];
      
      const events = [
        { id: 'e1', termId: 'term-1', courseId: 'c1', eventualType: 'examen', examType: '1er Parcial', dateISO: '2025-04-22T03:00:00.000Z', notes: 'Temas 1-4', status: 'confirmed' },
        { id: 'e2', termId: 'term-1', courseId: 'c2', eventualType: 'examen', examType: '1er Parcial', dateISO: '2025-04-25T03:00:00.000Z', notes: '', status: 'confirmed' },
        { id: 'e3', termId: 'term-1', courseId: 'c1', eventualType: 'entrega', examType: 'Otro', customExamType: 'TP Integrador', dateISO: '2025-05-15T03:00:00.000Z', notes: 'Trabajo pr√°ctico grupal', status: 'confirmed' },
        { id: 'e4', termId: 'term-1', courseId: 'c3', eventualType: 'examen', examType: '1er Parcial', dateISO: '2025-05-02T03:00:00.000Z', notes: '', status: 'confirmed' }
      ];
      
      const extracurricularSessions = [
        { id: 'extra-1', termId: 'term-1', kind: 'gym', dayOfWeek: 2, startTime: '18:00', endTime: '19:30', startDate: '2025-03-10', title: 'GYM', colorKey: 'gym', metadata: { muscleGroups: ['Piernas', 'Core'], note: '' } },
        { id: 'extra-2', termId: 'term-1', kind: 'tenis', dayOfWeek: 4, startTime: '19:00', endTime: '20:30', startDate: '2025-03-10', title: 'Tenis', colorKey: 'tenis', metadata: { intensity: 'Media', note: '' } }
      ];
      
      const extraMuscleGroupsPreset = ['Piernas', 'Isquios', 'Pecho', 'Espalda', 'Hombros', 'Brazos', 'Core', 'Mixto'];
      
      return { term, courses, weeklySessions, events, extracurricularSessions, extraMuscleGroupsPreset };
    }

    // ============ STORAGE ============
    
    function saveToStorage(data) {
      localStorage.setItem('miAgendaUniversitaria', JSON.stringify(data));
    }

    function loadFromStorage() {
      const stored = localStorage.getItem('miAgendaUniversitaria');
      if (stored) {
        try {
          const data = JSON.parse(stored);
          // Asegurar que existan los campos nuevos para retrocompatibilidad
          if (!data.extracurricularSessions) {
            data.extracurricularSessions = [];
          }
          if (!data.extraMuscleGroupsPreset) {
            data.extraMuscleGroupsPreset = ['Piernas', 'Isquios', 'Pecho', 'Espalda', 'Hombros', 'Brazos', 'Core', 'Mixto'];
          }
          return data;
        } catch (e) {
          console.error('Error al cargar datos:', e);
        }
      }
      return getDemoData();
    }

    // ============ COMPONENTES ============

    function App() {
      const [activeTab, setActiveTab] = useState('semana');
      const [showModal, setShowModal] = useState(false);
      const [showActivityModal, setShowActivityModal] = useState(false);
      const [editingActivity, setEditingActivity] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [selectedItem, setSelectedItem] = useState(null);
      const [showSidePanel, setShowSidePanel] = useState(false);
      
      const [data, setData] = useState(() => loadFromStorage());
      const { term, courses, weeklySessions, events, extracurricularSessions, extraMuscleGroupsPreset } = data;

      // Guardar autom√°ticamente
      useEffect(() => {
        saveToStorage(data);
      }, [data]);

      const conflicts = useMemo(() => {
        return detectConflicts(weeklySessions, courses);
      }, [weeklySessions, courses]);

      const handleExport = (format = 'normalized') => {
        let exportData;
        if (format === 'legacy') {
          exportData = exportToLegacyFormat(data);
        } else {
          exportData = data;
        }
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `agenda-universitaria-${format}.json`;
        a.click();
      };

      const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            
            // Detectar formato
            if (Array.isArray(imported)) {
              // Formato legado
              const converted = importLegacyData(imported);
              setData({
                term: createEmptyTerm(),
                courses: converted.courses,
                weeklySessions: converted.weeklySessions,
                events: converted.events,
                extracurricularSessions: [],
                extraMuscleGroupsPreset: ['Piernas', 'Isquios', 'Pecho', 'Espalda', 'Hombros', 'Brazos', 'Core', 'Mixto']
              });
            } else if (imported.term && imported.courses) {
              // Formato normalizado - asegurar campos nuevos
              if (!imported.extracurricularSessions) {
                imported.extracurricularSessions = [];
              }
              if (!imported.extraMuscleGroupsPreset) {
                imported.extraMuscleGroupsPreset = ['Piernas', 'Isquios', 'Pecho', 'Espalda', 'Hombros', 'Brazos', 'Core', 'Mixto'];
              }
              setData(imported);
            } else {
              alert('Formato de archivo no reconocido');
            }
          } catch (err) {
            alert('Error al importar: ' + err.message);
          }
        };
        reader.readAsText(file);
      };

      const handleOpenItem = (item, type) => {
        setSelectedItem({ ...item, type });
        setShowSidePanel(true);
      };

      const handleEditActivity = (activity) => {
        setEditingActivity(activity);
        setShowActivityModal(true);
      };

      const handleDeleteActivity = (activityId) => {
        const updatedExtras = (extracurricularSessions || []).filter(e => e.id !== activityId);
        setData({
          ...data,
          extracurricularSessions: updatedExtras
        });
      };

      return (
        <div className="app-container">
          <header className="app-header">
            <div className="app-container">
              <div className="header-content">
                <h1 className="app-title">Mi agenda Universitaria</h1>
                <div className="header-actions">
                  <button className="btn btn-secondary" onClick={() => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = handleImport;
                    input.click();
                  }}>
                    Importar JSON
                  </button>
                  <button className="btn btn-secondary" onClick={() => handleExport('normalized')}>
                    Exportar
                  </button>
                  <button className="btn btn-primary" onClick={() => setShowModal(true)}>
                    Agregar / Editar datos
                  </button>
                  <button className="btn btn-primary" onClick={() => setShowActivityModal(true)}>
                    + Actividad
                  </button>
                </div>
              </div>
              
              <div className="search-bar">
                <input
                  type="text"
                  className="search-input"
                  placeholder="Buscar por materia, docente, aula, comisi√≥n..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
              </div>
            </div>
          </header>

          {conflicts.length > 0 && (
            <div className="app-container">
              <div className="alert alert-warning">
                <strong>‚ö†Ô∏è</strong>
                <div>
                  <strong>Conflictos detectados:</strong>
                  <ul style={{ marginTop: '0.5rem', paddingLeft: '1.5rem' }}>
                    {conflicts.slice(0, 3).map((c, i) => (
                      <li key={i}>
                        {c.type === 'overlap' ? 'Superposici√≥n' : 'Clases pegadas'}: 
                        {' '}{c.session1.courseName} y {c.session2.courseName} el {getDayName(c.session1.dayOfWeek)}
                      </li>
                    ))}
                  </ul>
                  {conflicts.length > 3 && <div>Y {conflicts.length - 3} m√°s...</div>}
                </div>
              </div>
            </div>
          )}

          <div className="app-container">
            <div className="tabs">
              <button
                className={`tab ${activeTab === 'semana' ? 'active' : ''}`}
                onClick={() => setActiveTab('semana')}
              >
                Semana
              </button>
              <button
                className={`tab ${activeTab === 'mes' ? 'active' : ''}`}
                onClick={() => setActiveTab('mes')}
              >
                Mes
              </button>
              <button
                className={`tab ${activeTab === 'lista' ? 'active' : ''}`}
                onClick={() => setActiveTab('lista')}
              >
                Lista
              </button>
              <button
                className={`tab ${activeTab === 'estadisticas' ? 'active' : ''}`}
                onClick={() => setActiveTab('estadisticas')}
              >
                Estad√≠sticas
              </button>
            </div>

            {activeTab === 'semana' && (
              <WeekView
                sessions={weeklySessions}
                courses={courses}
                extracurricularSessions={extracurricularSessions}
                searchQuery={searchQuery}
                onOpenItem={handleOpenItem}
              />
            )}
            
            {activeTab === 'mes' && (
              <MonthView
                sessions={weeklySessions}
                events={events}
                courses={courses}
                term={term}
                searchQuery={searchQuery}
                onOpenItem={handleOpenItem}
              />
            )}
            
            {activeTab === 'lista' && (
              <ListView
                sessions={weeklySessions}
                events={events}
                courses={courses}
                searchQuery={searchQuery}
                onOpenItem={handleOpenItem}
              />
            )}
            
            {activeTab === 'estadisticas' && (
              <StatsView
                sessions={weeklySessions}
                events={events}
                courses={courses}
                term={term}
              />
            )}
          </div>

          {showModal && (
            <DataModal
              data={data}
              onSave={(newData) => {
                setData(newData);
                setShowModal(false);
              }}
              onClose={() => setShowModal(false)}
            />
          )}

          {showActivityModal && (
            <ActivityModal
              data={data}
              editingActivity={editingActivity}
              onSave={(newData) => {
                setData(newData);
                setShowActivityModal(false);
                setEditingActivity(null);
              }}
              onClose={() => {
                setShowActivityModal(false);
                setEditingActivity(null);
              }}
            />
          )}

          {showSidePanel && (
            <SidePanel
              item={selectedItem}
              courses={courses}
              sessions={weeklySessions}
              events={events}
              onClose={() => setShowSidePanel(false)}
              onEdit={handleEditActivity}
              onDelete={handleDeleteActivity}
            />
          )}
        </div>
      );
    }

    // ============ VISTA SEMANA ============
    
    function WeekView({ sessions, courses, extracurricularSessions, searchQuery, onOpenItem }) {
      const hours = Array.from({ length: 13 }, (_, i) => 8 + i); // 8:00 a 20:00 (√∫ltima marca es 20:00, termina a las 21:00)
      const isMobile = window.innerWidth <= 768;
      const PIXELS_PER_HOUR = isMobile ? 50 : 60; // Cada hora = 50px en mobile, 60px en desktop

      const filteredSessions = sessions.filter(s => {
        if (!searchQuery) return true;
        const course = courses.find(c => c.id === s.courseId);
        const q = searchQuery.toLowerCase();
        return (
          course?.nombre.toLowerCase().includes(q) ||
          s.docente?.toLowerCase().includes(q) ||
          s.aula?.toLowerCase().includes(q) ||
          s.numeroComision?.toLowerCase().includes(q) ||
          s.modalidad.toLowerCase().includes(q)
        );
      });
      
      const filteredExtras = (extracurricularSessions || []).filter(e => {
        if (!searchQuery) return true;
        const q = searchQuery.toLowerCase();
        const title = getActivityTitle(e).toLowerCase();
        const note = e.metadata?.note?.toLowerCase() || '';
        const desc = e.metadata?.otherDescription?.toLowerCase() || '';
        const groups = (e.metadata?.muscleGroups || []).join(' ').toLowerCase();
        return title.includes(q) || note.includes(q) || desc.includes(q) || groups.includes(q);
      });

      const getSessionsForDay = (day) => {
        return filteredSessions.filter(s => s.dayOfWeek === day);
      };
      
      const getExtrasForDay = (day) => {
        return filteredExtras.filter(e => e.dayOfWeek === day);
      };

      const calculateSessionPosition = (session) => {
        const [startHour, startMin] = session.startTime.split(':').map(Number);
        const [endHour, endMin] = session.endTime.split(':').map(Number);
        
        const startMinutes = (startHour - 8) * 60 + startMin; // Offset desde las 8:00
        const endMinutes = (endHour - 8) * 60 + endMin;
        const durationMinutes = endMinutes - startMinutes;
        
        const top = (startMinutes / 60) * PIXELS_PER_HOUR;
        const height = (durationMinutes / 60) * PIXELS_PER_HOUR;
        
        return { top, height };
      };

      return (
        <div className="week-view">
          <div style={{ display: 'flex', marginBottom: '1rem', gap: '0' }}>
            <div style={{ width: isMobile ? '60px' : '80px', background: 'var(--surface)', padding: '1rem 0.5rem', textAlign: 'center', fontWeight: 600, border: '1px solid var(--border)', borderRight: 'none' }}>
              Hora
            </div>
            {DAYS.map((day, idx) => (
              <div key={day} style={{ flex: 1, background: 'var(--primary)', color: 'white', padding: '1rem 0.5rem', textAlign: 'center', fontWeight: 600, border: '1px solid var(--border)', borderLeft: idx === 0 ? '1px solid var(--border)' : 'none' }}>
                {day}
              </div>
            ))}
          </div>
          
          <div className="week-grid">
            <div className="week-time-column">
              {hours.map(hour => (
                <div key={hour} className="time-slot">
                  {hour}:00
                </div>
              ))}
            </div>
            
            <div className="week-days-grid">
              {[1, 2, 3, 4, 5].map(day => (
                <div key={day} className="day-column">
                  <div className="day-column-bg">
                    {hours.map(hour => (
                      <div key={hour} className="hour-line"></div>
                    ))}
                  </div>
                  
                  {getSessionsForDay(day).map(session => {
                    const course = courses.find(c => c.id === session.courseId);
                    const { top, height } = calculateSessionPosition(session);
                    
                    return (
                      <div
                        key={session.id}
                        className={`session-block ${session.modalidad}`}
                        style={{ top: `${top}px`, height: `${height}px` }}
                        onClick={() => onOpenItem(course, 'course')}
                      >
                        <div className="session-name">{course?.nombre}</div>
                        <div className="session-time">
                          {formatTime(session.startTime)} - {formatTime(session.endTime)}
                        </div>
                        {session.aula && <div className="session-time">{session.aula}</div>}
                      </div>
                    );
                  })}
                  
                  {getExtrasForDay(day).map(extra => {
                    const { top, height } = calculateSessionPosition(extra);
                    
                    return (
                      <div
                        key={extra.id}
                        className={`session-block ${extra.colorKey}`}
                        style={{ top: `${top}px`, height: `${height}px` }}
                        onClick={() => onOpenItem(extra, 'extra')}
                      >
                        <div className="session-name">
                          <span className="session-icon">{getActivityIcon(extra.kind)}</span>
                          {getActivityTitle(extra)}
                        </div>
                        <div className="session-time">
                          {formatTime(extra.startTime)} - {formatTime(extra.endTime)}
                        </div>
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ============ VISTA MES ============
    
    function MonthView({ sessions, events, courses, term, searchQuery, onOpenItem }) {
      const [currentDate, setCurrentDate] = useState(new Date());
      
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      const daysInMonth = getDaysInMonth(year, month);
      const firstDay = getFirstDayOfMonth(year, month);
      
      const prevMonth = () => {
        setCurrentDate(new Date(year, month - 1, 1));
      };
      
      const nextMonth = () => {
        setCurrentDate(new Date(year, month + 1, 1));
      };

      const getSessionsForDate = (date) => {
        const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay();
        return sessions.filter(s => {
          if (s.dayOfWeek !== dayOfWeek) return false;
          
          // Verificar que est√° dentro del per√≠odo
          const termStart = new Date(term.startDate);
          const termEnd = new Date(term.endDate);
          return date >= termStart && date <= termEnd;
        });
      };

      const getEventsForDate = (date) => {
        return events.filter(e => {
          const eventDate = new Date(e.dateISO);
          return isSameDay(eventDate, date);
        });
      };

      const days = [];
      
      // D√≠as del mes anterior
      const prevMonthDays = getDaysInMonth(year, month - 1);
      for (let i = firstDay - 2; i >= 0; i--) {
        days.push({
          day: prevMonthDays - i,
          isCurrentMonth: false,
          date: new Date(year, month - 1, prevMonthDays - i)
        });
      }
      
      // D√≠as del mes actual
      for (let i = 1; i <= daysInMonth; i++) {
        days.push({
          day: i,
          isCurrentMonth: true,
          date: new Date(year, month, i)
        });
      }
      
      // D√≠as del mes siguiente
      const remaining = 42 - days.length; // 6 semanas
      for (let i = 1; i <= remaining; i++) {
        days.push({
          day: i,
          isCurrentMonth: false,
          date: new Date(year, month + 1, i)
        });
      }

      return (
        <div className="month-view">
          <div className="month-header">
            <h2 className="month-title">{getMonthName(month)} {year}</h2>
            <div className="month-nav">
              <button className="btn btn-secondary btn-sm" onClick={prevMonth}>‚Üê Anterior</button>
              <button className="btn btn-secondary btn-sm" onClick={nextMonth}>Siguiente ‚Üí</button>
            </div>
          </div>
          
          <div className="month-grid">
            {DAYS.map(day => (
              <div key={day} className="month-day-header">{day}</div>
            ))}
            
            {days.map((dayInfo, idx) => {
              const daySessions = getSessionsForDate(dayInfo.date);
              const dayEvents = getEventsForDate(dayInfo.date);
              
              return (
                <div
                  key={idx}
                  className={`month-day ${!dayInfo.isCurrentMonth ? 'other-month' : ''}`}
                >
                  <div className="month-day-number">{dayInfo.day}</div>
                  
                  {daySessions.length > 0 && (
                    <div>
                      {daySessions.slice(0, 2).map((s, i) => (
                        <span key={i} className="month-day-indicator"></span>
                      ))}
                    </div>
                  )}
                  
                  {dayEvents.slice(0, 2).map(event => {
                    const course = courses.find(c => c.id === event.courseId);
                    // Abreviar el nombre de la materia si es muy largo
                    const courseName = course?.nombre || '';
                    const shortName = courseName.length > 15 ? courseName.substring(0, 12) + '...' : courseName;
                    
                    return (
                      <div
                        key={event.id}
                        className="month-event"
                        onClick={() => onOpenItem(event, 'event')}
                        title={`${courseName} - ${getExamTypeName(event)}`}
                      >
                        {shortName}
                      </div>
                    );
                  })}
                  {dayEvents.length > 2 && (
                    <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem', fontWeight: 500 }}>
                      +{dayEvents.length - 2} m√°s
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // ============ VISTA LISTA ============
    
    function ListView({ sessions, events, courses, searchQuery, onOpenItem }) {
      const [filter, setFilter] = useState('todos');

      const allItems = useMemo(() => {
        const items = [];
        
        // Agrupar sesiones por materia
        const sessionsByCourse = new Map();
        sessions.forEach(s => {
          if (!sessionsByCourse.has(s.courseId)) {
            sessionsByCourse.set(s.courseId, []);
          }
          sessionsByCourse.get(s.courseId).push(s);
        });
        
        sessionsByCourse.forEach((courseSessions, courseId) => {
          const course = courses.find(c => c.id === courseId);
          courseSessions.forEach(session => {
            items.push({
              type: 'session',
              id: session.id,
              courseId: courseId,
              courseName: course?.nombre || '',
              modalidad: session.modalidad,
              day: getDayName(session.dayOfWeek),
              time: `${formatTime(session.startTime)} - ${formatTime(session.endTime)}`,
              aula: session.aula,
              docente: session.docente,
              comision: session.numeroComision,
              data: session
            });
          });
        });
        
        // Agregar eventos
        events.forEach(event => {
          const course = courses.find(c => c.id === event.courseId);
          const date = new Date(event.dateISO);
          items.push({
            type: 'event',
            id: event.id,
            courseId: event.courseId,
            courseName: course?.nombre || '',
            eventType: event.eventualType,
            examType: getExamTypeName(event),
            date: date.toLocaleDateString('es-AR'),
            notes: event.notes,
            data: event
          });
        });
        
        return items;
      }, [sessions, events, courses]);

      const filteredItems = allItems.filter(item => {
        // Filtro por tipo
        if (filter === 'clases' && item.type !== 'session') return false;
        if (filter === 'examenes' && item.type !== 'event') return false;
        
        // Filtro por b√∫squeda
        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          return (
            item.courseName.toLowerCase().includes(q) ||
            item.docente?.toLowerCase().includes(q) ||
            item.aula?.toLowerCase().includes(q) ||
            item.comision?.toLowerCase().includes(q) ||
            item.modalidad?.toLowerCase().includes(q) ||
            item.examType?.toLowerCase().includes(q)
          );
        }
        
        return true;
      });

      return (
        <div className="list-view">
          <div className="list-filters">
            <button
              className={`btn ${filter === 'todos' ? 'btn-primary' : 'btn-secondary'} btn-sm`}
              onClick={() => setFilter('todos')}
            >
              Todos
            </button>
            <button
              className={`btn ${filter === 'clases' ? 'btn-primary' : 'btn-secondary'} btn-sm`}
              onClick={() => setFilter('clases')}
            >
              Clases
            </button>
            <button
              className={`btn ${filter === 'examenes' ? 'btn-primary' : 'btn-secondary'} btn-sm`}
              onClick={() => setFilter('examenes')}
            >
              Ex√°menes
            </button>
          </div>

          {filteredItems.length === 0 ? (
            <div className="empty-state">
              <div className="empty-state-icon">üìö</div>
              <p>No se encontraron resultados</p>
            </div>
          ) : (
            filteredItems.map(item => (
              <div
                key={item.id}
                className="list-item"
                onClick={() => {
                  const course = courses.find(c => c.id === item.courseId);
                  onOpenItem(course, 'course');
                }}
              >
                <div className="list-item-header">
                  <div className="list-item-title">{item.courseName}</div>
                  {item.type === 'session' && (
                    <span className={`list-item-badge badge-${item.modalidad}`}>
                      {item.modalidad}
                    </span>
                  )}
                  {item.type === 'event' && (
                    <span className="list-item-badge badge-examen">
                      {item.examType}
                    </span>
                  )}
                </div>
                
                <div className="list-item-details">
                  {item.type === 'session' && (
                    <>
                      {item.day} ‚Ä¢ {item.time}
                      {item.aula && ` ‚Ä¢ ${item.aula}`}
                      {item.docente && ` ‚Ä¢ ${item.docente}`}
                      {item.comision && ` ‚Ä¢ ${item.comision}`}
                    </>
                  )}
                  {item.type === 'event' && (
                    <>
                      {item.date}
                      {item.notes && ` ‚Ä¢ ${item.notes}`}
                    </>
                  )}
                </div>
              </div>
            ))
          )}
        </div>
      );
    }

    // ============ VISTA ESTAD√çSTICAS ============
    
    function StatsView({ sessions, events, courses, term }) {
      const stats = useMemo(() => {
        const totalCourses = courses.length;
        
        // Calcular total de clases
        let totalClasses = 0;
        sessions.forEach(session => {
          const occurrences = generateSessionOccurrences(session, term);
          totalClasses += occurrences.length;
        });
        
        // Estad√≠sticas por materia
        const courseStats = courses.map(course => {
          const courseSessions = sessions.filter(s => s.courseId === course.id);
          const courseEvents = events.filter(e => e.courseId === course.id);
          
          let totalSessionOccurrences = 0;
          courseSessions.forEach(session => {
            const occurrences = generateSessionOccurrences(session, term);
            totalSessionOccurrences += occurrences.length;
          });
          
          return {
            course,
            totalSessions: totalSessionOccurrences,
            sessionTypes: courseSessions.map(s => ({
              modalidad: s.modalidad,
              count: generateSessionOccurrences(s, term).length
            })),
            events: courseEvents.length
          };
        });
        
        return {
          totalCourses,
          totalClasses,
          courseStats
        };
      }, [sessions, events, courses, term]);

      return (
        <div className="stats-view">
          <div className="stat-card">
            <div className="stat-title">Total Materias</div>
            <div className="stat-value">{stats.totalCourses}</div>
            <div className="stat-subtitle">En el {term.nombre}</div>
          </div>
          
          <div className="stat-card">
            <div className="stat-title">Total Clases</div>
            <div className="stat-value">{stats.totalClasses}</div>
            <div className="stat-subtitle">
              Del {new Date(term.startDate).toLocaleDateString('es-AR')} al{' '}
              {new Date(term.endDate).toLocaleDateString('es-AR')}
            </div>
          </div>
          
          <div className="stat-card">
            <div className="stat-title">Clases Restantes</div>
            <div className="stat-value">{stats.totalClasses}</div>
            <div className="stat-subtitle">Sin sistema de asistencia activo</div>
          </div>
          
          <div className="stat-card" style={{ gridColumn: '1 / -1' }}>
            <div className="stat-title">Detalle por Materia</div>
            <div className="stat-list">
              {stats.courseStats.map(({ course, totalSessions, sessionTypes, events }) => (
                <div key={course.id} className="stat-list-item">
                  <div>
                    <strong>{course.nombre}</strong>
                    <div style={{ fontSize: '0.85rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>
                      {sessionTypes.map((st, i) => (
                        <span key={i}>
                          {st.modalidad}: {st.count} clases
                          {i < sessionTypes.length - 1 ? ' ‚Ä¢ ' : ''}
                        </span>
                      ))}
                      {events > 0 && ` ‚Ä¢ ${events} ex√°menes/entregas`}
                    </div>
                  </div>
                  <div style={{ fontWeight: 600, color: 'var(--primary)' }}>
                    {totalSessions} clases
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ============ MODAL DE ACTIVIDADES EXTRACURRICULARES ============
    
    function ActivityModal({ data, editingActivity, onSave, onClose }) {
      const [step, setStep] = useState(editingActivity ? 1 : 0);
      const [activity, setActivity] = useState(editingActivity || createEmptyExtracurricularSession());
      const [conflicts, setConflicts] = useState([]);
      const [showNewMuscleInput, setShowNewMuscleInput] = useState(false);
      const [newMuscleGroup, setNewMuscleGroup] = useState('');

      const activityTypes = [
        { kind: 'gym', label: 'Gym', icon: 'üèãÔ∏è' },
        { kind: 'tenis', label: 'Tenis', icon: 'üéæ' },
        { kind: 'clase_tenis', label: 'Clases de tenis', icon: 'üßë‚Äçüè´' },
        { kind: 'otra', label: 'Otra', icon: '‚ú≥Ô∏è' }
      ];

      const handleTypeSelect = (kind) => {
        let title = 'Actividad';
        if (kind === 'gym') title = 'GYM';
        else if (kind === 'tenis') title = 'Tenis';
        else if (kind === 'clase_tenis') title = 'Clase Tenis';
        else if (kind === 'otra') title = 'Otra';
        
        setActivity({ 
          ...activity, 
          kind, 
          colorKey: kind,
          title
        });
        setStep(1);
      };

      const handleSave = () => {
        // Validar horarios
        if (!activity.startTime || !activity.endTime) {
          alert('Debe completar hora de inicio y fin');
          return;
        }
        
        if (!activity.startDate) {
          alert('Debe completar la fecha de inicio');
          return;
        }
        
        const start = parseTime(activity.startTime);
        const end = parseTime(activity.endTime);
        
        if (start >= end) {
          alert('La hora de fin debe ser posterior a la hora de inicio');
          return;
        }
        
        // Validar choques (pasando el ID si estamos editando)
        const detectedConflicts = validateExtracurricularConflict(
          activity,
          data.weeklySessions,
          data.extracurricularSessions || [],
          data.courses,
          editingActivity ? activity.id : null
        );
        
        if (detectedConflicts.length > 0) {
          setConflicts(detectedConflicts);
          return;
        }
        
        // Advertir si est√° fuera del rango visual
        if (start < parseTime('08:00') || end > parseTime('21:00')) {
          if (!confirm('El horario est√° fuera del rango visual (8:00-21:00). ¬øDesea continuar de todos modos?')) {
            return;
          }
        }
        
        // Advertencia suave para "Otra" sin descripci√≥n
        if (activity.kind === 'otra' && !activity.metadata.otherDescription) {
          if (!confirm('No especific√≥ qu√© tipo de actividad es "Otra". ¬øDesea continuar de todos modos?')) {
            return;
          }
        }
        
        // Guardar (editar o crear)
        let updatedExtras;
        if (editingActivity) {
          // Edici√≥n: reemplazar la actividad existente
          updatedExtras = (data.extracurricularSessions || []).map(e => 
            e.id === activity.id ? activity : e
          );
        } else {
          // Creaci√≥n: agregar nueva
          updatedExtras = [...(data.extracurricularSessions || []), activity];
        }
        
        onSave({
          ...data,
          extracurricularSessions: updatedExtras
        });
      };

      const toggleMuscleGroup = (group) => {
        const current = activity.metadata.muscleGroups || [];
        const updated = current.includes(group)
          ? current.filter(g => g !== group)
          : [...current, group];
        
        setActivity({
          ...activity,
          metadata: { ...activity.metadata, muscleGroups: updated }
        });
      };
      
      const handleAddNewMuscle = () => {
        if (!newMuscleGroup.trim()) return;
        
        const updatedPreset = [...(data.extraMuscleGroupsPreset || []), newMuscleGroup];
        onSave({
          ...data,
          extraMuscleGroupsPreset: updatedPreset
        });
        
        toggleMuscleGroup(newMuscleGroup);
        setNewMuscleGroup('');
        setShowNewMuscleInput(false);
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">{editingActivity ? 'Editar Actividad' : '+ Actividad Extracurricular'}</h2>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            
            <div className="modal-body">
              {conflicts.length > 0 && (
                <div className="alert alert-error">
                  <strong>‚ö†Ô∏è Choque de horario detectado</strong>
                  <div style={{ marginTop: '0.5rem' }}>
                    {conflicts.map((c, i) => (
                      <div key={i}>‚Ä¢ {c.name} ({formatTime(c.startTime)}-{formatTime(c.endTime)})</div>
                    ))}
                  </div>
                  <div style={{ marginTop: '0.5rem', fontSize: '0.9rem' }}>
                    No se puede guardar la actividad con este horario. Por favor, elija otro horario.
                  </div>
                </div>
              )}

              {step === 0 && (
                <div>
                  <p style={{ marginBottom: '1rem', color: 'var(--text-muted)' }}>
                    Seleccione el tipo de actividad:
                  </p>
                  <div className="activity-type-cards">
                    {activityTypes.map(type => (
                      <div
                        key={type.kind}
                        className={`activity-type-card ${activity.kind === type.kind ? 'selected' : ''}`}
                        onClick={() => handleTypeSelect(type.kind)}
                      >
                        <div className="activity-type-icon">{type.icon}</div>
                        <div className="activity-type-label">{type.label}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {step === 1 && (
                <div>
                  <div style={{ marginBottom: '1.5rem', padding: '1rem', background: 'var(--background)', borderRadius: '8px' }}>
                    <strong>Tipo seleccionado:</strong> {activityTypes.find(t => t.kind === activity.kind)?.label}
                  </div>

                  <div className="form-row">
                    <div className="form-group">
                      <label className="form-label">D√≠a *</label>
                      <select
                        className="form-select"
                        value={activity.dayOfWeek}
                        onChange={(e) => {
                          setActivity({ ...activity, dayOfWeek: parseInt(e.target.value) });
                          setConflicts([]);
                        }}
                      >
                        {DAYS_FULL.slice(0, 5).map((day, i) => (
                          <option key={i} value={i + 1}>{day}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div className="form-group">
                      <label className="form-label">Fecha de inicio *</label>
                      <input
                        type="date"
                        className="form-input"
                        value={activity.startDate || ''}
                        onChange={(e) => {
                          setActivity({ ...activity, startDate: e.target.value });
                        }}
                      />
                    </div>

                    <div className="form-group">
                      <label className="form-label">Hora inicio *</label>
                      <input
                        type="time"
                        className="form-input"
                        value={activity.startTime}
                        onChange={(e) => {
                          setActivity({ ...activity, startTime: e.target.value });
                          setConflicts([]);
                        }}
                      />
                    </div>

                    <div className="form-group">
                      <label className="form-label">Hora fin *</label>
                      <input
                        type="time"
                        className="form-input"
                        value={activity.endTime}
                        onChange={(e) => {
                          setActivity({ ...activity, endTime: e.target.value });
                          setConflicts([]);
                        }}
                      />
                    </div>
                  </div>

                  {/* Campos espec√≠ficos por tipo */}
                  {activity.kind === 'gym' && (
                    <div>
                      <div className="form-group">
                        <label className="form-label">Grupos musculares (opcional)</label>
                        <div className="multi-select-group">
                          {(data.extraMuscleGroupsPreset || []).map(group => (
                            <div
                              key={group}
                              className={`multi-select-item ${(activity.metadata.muscleGroups || []).includes(group) ? 'selected' : ''}`}
                              onClick={() => toggleMuscleGroup(group)}
                            >
                              {group}
                            </div>
                          ))}
                        </div>
                        
                        {!showNewMuscleInput ? (
                          <button 
                            className="btn btn-secondary btn-sm" 
                            onClick={() => setShowNewMuscleInput(true)}
                            style={{ marginTop: '0.5rem' }}
                          >
                            + Agregar nuevo grupo
                          </button>
                        ) : (
                          <div style={{ marginTop: '0.5rem', display: 'flex', gap: '0.5rem' }}>
                            <input
                              type="text"
                              className="form-input"
                              placeholder="Nombre del grupo muscular"
                              value={newMuscleGroup}
                              onChange={(e) => setNewMuscleGroup(e.target.value)}
                              style={{ flex: 1 }}
                            />
                            <button className="btn btn-primary btn-sm" onClick={handleAddNewMuscle}>
                              Agregar
                            </button>
                            <button className="btn btn-secondary btn-sm" onClick={() => {
                              setShowNewMuscleInput(false);
                              setNewMuscleGroup('');
                            }}>
                              Cancelar
                            </button>
                          </div>
                        )}
                      </div>
                      
                      <div className="form-group">
                        <label className="form-label">Notas (opcional)</label>
                        <textarea
                          className="form-textarea"
                          value={activity.metadata.note || ''}
                          onChange={(e) => setActivity({
                            ...activity,
                            metadata: { ...activity.metadata, note: e.target.value }
                          })}
                          placeholder="Observaciones, ejercicios espec√≠ficos, etc."
                        />
                      </div>
                    </div>
                  )}

                  {activity.kind === 'tenis' && (
                    <div>
                      <div className="form-group">
                        <label className="form-label">Intensidad (opcional)</label>
                        <select
                          className="form-select"
                          value={activity.metadata.intensity || ''}
                          onChange={(e) => setActivity({
                            ...activity,
                            metadata: { ...activity.metadata, intensity: e.target.value }
                          })}
                        >
                          <option value="">Seleccionar...</option>
                          <option value="Baja">Baja</option>
                          <option value="Media">Media</option>
                          <option value="Alta">Alta</option>
                        </select>
                      </div>
                      
                      <div className="form-group">
                        <label className="form-label">Notas (opcional)</label>
                        <textarea
                          className="form-textarea"
                          value={activity.metadata.note || ''}
                          onChange={(e) => setActivity({
                            ...activity,
                            metadata: { ...activity.metadata, note: e.target.value }
                          })}
                          placeholder="Observaciones sobre el entrenamiento..."
                        />
                      </div>
                    </div>
                  )}

                  {activity.kind === 'clase_tenis' && (
                    <div>
                      <div className="form-group">
                        <label className="form-label">Nivel alumnos (opcional)</label>
                        <select
                          className="form-select"
                          value={activity.metadata.studentLevel || ''}
                          onChange={(e) => setActivity({
                            ...activity,
                            metadata: { ...activity.metadata, studentLevel: e.target.value }
                          })}
                        >
                          <option value="">Seleccionar...</option>
                          <option value="Inicial">Inicial</option>
                          <option value="Intermedio">Intermedio</option>
                          <option value="Avanzado">Avanzado</option>
                          <option value="Competici√≥n">Competici√≥n</option>
                          <option value="Mixto">Mixto</option>
                        </select>
                      </div>
                      
                      <div className="form-group">
                        <label className="form-label">Modalidad (opcional)</label>
                        <div style={{ display: 'flex', gap: '1rem', marginTop: '0.5rem' }}>
                          <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                            <input
                              type="radio"
                              name="modality"
                              value="Individual"
                              checked={activity.metadata.modality === 'Individual'}
                              onChange={(e) => setActivity({
                                ...activity,
                                metadata: { ...activity.metadata, modality: e.target.value, studentCount: null }
                              })}
                              style={{ marginRight: '0.5rem' }}
                            />
                            Individual
                          </label>
                          <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                            <input
                              type="radio"
                              name="modality"
                              value="Grupal"
                              checked={activity.metadata.modality === 'Grupal'}
                              onChange={(e) => setActivity({
                                ...activity,
                                metadata: { ...activity.metadata, modality: e.target.value }
                              })}
                              style={{ marginRight: '0.5rem' }}
                            />
                            Grupal
                          </label>
                        </div>
                      </div>
                      
                      {activity.metadata.modality === 'Grupal' && (
                        <div className="form-group">
                          <label className="form-label">Cantidad de alumnos (opcional)</label>
                          <input
                            type="number"
                            className="form-input"
                            value={activity.metadata.studentCount || ''}
                            onChange={(e) => setActivity({
                              ...activity,
                              metadata: { ...activity.metadata, studentCount: parseInt(e.target.value) || null }
                            })}
                            placeholder="Ej: 4"
                            min="1"
                          />
                        </div>
                      )}
                      
                      <div className="form-group">
                        <label className="form-label">Notas (opcional)</label>
                        <textarea
                          className="form-textarea"
                          value={activity.metadata.note || ''}
                          onChange={(e) => setActivity({
                            ...activity,
                            metadata: { ...activity.metadata, note: e.target.value }
                          })}
                          placeholder="Observaciones sobre la clase..."
                        />
                      </div>
                    </div>
                  )}

                  {activity.kind === 'otra' && (
                    <div>
                      <div className="form-group">
                        <label className="form-label">Especificar (recomendado)</label>
                        <textarea
                          className="form-textarea"
                          value={activity.metadata.otherDescription || ''}
                          onChange={(e) => setActivity({
                            ...activity,
                            metadata: { ...activity.metadata, otherDescription: e.target.value }
                          })}
                          placeholder="¬øQu√© tipo de actividad es? Ej: Tr√°mite, M√©dico, Reunion, etc."
                        />
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
            
            <div className="modal-footer">
              {step === 1 && (
                <button className="btn btn-secondary" onClick={() => setStep(0)}>
                  Atr√°s
                </button>
              )}
              {step === 1 && (
                <button className="btn btn-primary" onClick={handleSave}>
                  Guardar actividad
                </button>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ============ MODAL DE DATOS ============
    
    function DataModal({ data, onSave, onClose }) {
      const [step, setStep] = useState(0);
      const [formData, setFormData] = useState(data);

      const steps = ['Per√≠odo', 'Materias', 'Cursadas', 'Ex√°menes'];

      const handleNext = () => {
        if (step < steps.length - 1) {
          setStep(step + 1);
        } else {
          onSave(formData);
        }
      };

      const handleBack = () => {
        if (step > 0) setStep(step - 1);
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">Configurar datos acad√©micos</h2>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            
            <div className="modal-body">
              <div className="stepper">
                {steps.map((s, i) => (
                  <div key={s} className={`step ${i === step ? 'active' : ''} ${i < step ? 'completed' : ''}`}>
                    <div className="step-number">{i + 1}</div>
                    <div className="step-label">{s}</div>
                  </div>
                ))}
              </div>

              {step === 0 && (
                <TermStep
                  term={formData.term}
                  onChange={(term) => setFormData({ ...formData, term })}
                />
              )}
              
              {step === 1 && (
                <CoursesStep
                  courses={formData.courses}
                  onChange={(courses) => setFormData({ ...formData, courses })}
                />
              )}
              
              {step === 2 && (
                <SessionsStep
                  sessions={formData.weeklySessions}
                  courses={formData.courses}
                  onChange={(sessions) => setFormData({ ...formData, weeklySessions: sessions })}
                />
              )}
              
              {step === 3 && (
                <EventsStep
                  events={formData.events}
                  courses={formData.courses}
                  onChange={(events) => setFormData({ ...formData, events })}
                />
              )}
            </div>
            
            <div className="modal-footer">
              {step > 0 && (
                <button className="btn btn-secondary" onClick={handleBack}>
                  Atr√°s
                </button>
              )}
              <button className="btn btn-primary" onClick={handleNext}>
                {step === steps.length - 1 ? 'Guardar' : 'Siguiente'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    function TermStep({ term, onChange }) {
      return (
        <div>
          <div className="form-group">
            <label className="form-label">Nombre del per√≠odo</label>
            <input
              type="text"
              className="form-input"
              value={term.nombre}
              onChange={(e) => onChange({ ...term, nombre: e.target.value })}
            />
          </div>
          
          <div className="form-row">
            <div className="form-group">
              <label className="form-label">Fecha de inicio</label>
              <input
                type="date"
                className="form-input"
                value={term.startDate}
                onChange={(e) => onChange({ ...term, startDate: e.target.value })}
              />
            </div>
            
            <div className="form-group">
              <label className="form-label">Fecha de fin</label>
              <input
                type="date"
                className="form-input"
                value={term.endDate}
                onChange={(e) => onChange({ ...term, endDate: e.target.value })}
              />
            </div>
          </div>
        </div>
      );
    }

    function CoursesStep({ courses, onChange }) {
      const handleAdd = () => {
        onChange([...courses, createEmptyCourse()]);
      };

      const handleRemove = (index) => {
        onChange(courses.filter((_, i) => i !== index));
      };

      const handleChange = (index, field, value) => {
        const updated = [...courses];
        updated[index] = { ...updated[index], [field]: value };
        onChange(updated);
      };

      return (
        <div>
          <div className="item-list">
            {courses.map((course, index) => (
              <div key={course.id} className="item-entry">
                <div style={{ flex: 1 }}>
                  <input
                    type="text"
                    className="form-input"
                    placeholder="Nombre de la materia"
                    value={course.nombre}
                    onChange={(e) => handleChange(index, 'nombre', e.target.value)}
                  />
                </div>
                <div className="item-entry-actions">
                  <button className="btn btn-danger btn-sm" onClick={() => handleRemove(index)}>
                    Eliminar
                  </button>
                </div>
              </div>
            ))}
          </div>
          
          <button className="btn btn-secondary" onClick={handleAdd} style={{ marginTop: '1rem' }}>
            + Agregar materia
          </button>
        </div>
      );
    }

    function SessionsStep({ sessions, courses, onChange }) {
      const handleAdd = () => {
        onChange([...sessions, createEmptyWeeklySession()]);
      };

      const handleRemove = (index) => {
        onChange(sessions.filter((_, i) => i !== index));
      };

      const handleChange = (index, field, value) => {
        const updated = [...sessions];
        updated[index] = { ...updated[index], [field]: value };
        onChange(updated);
      };

      return (
        <div>
          <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
            {sessions.map((session, index) => (
              <div key={session.id} style={{ marginBottom: '1.5rem', padding: '1rem', background: 'var(--background)', borderRadius: '8px' }}>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Materia</label>
                    <select
                      className="form-select"
                      value={session.courseId}
                      onChange={(e) => handleChange(index, 'courseId', e.target.value)}
                    >
                      <option value="">Seleccionar...</option>
                      {courses.map(c => (
                        <option key={c.id} value={c.id}>{c.nombre}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Modalidad</label>
                    <select
                      className="form-select"
                      value={session.modalidad}
                      onChange={(e) => handleChange(index, 'modalidad', e.target.value)}
                    >
                      <option value="teoria">Teor√≠a</option>
                      <option value="practica">Pr√°ctica</option>
                    </select>
                  </div>
                </div>
                
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">D√≠a</label>
                    <select
                      className="form-select"
                      value={session.dayOfWeek}
                      onChange={(e) => handleChange(index, 'dayOfWeek', parseInt(e.target.value))}
                    >
                      {DAYS_FULL.map((day, i) => (
                        <option key={i} value={i + 1}>{day}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Hora inicio</label>
                    <input
                      type="time"
                      className="form-input"
                      value={session.startTime}
                      onChange={(e) => handleChange(index, 'startTime', e.target.value)}
                    />
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Hora fin</label>
                    <input
                      type="time"
                      className="form-input"
                      value={session.endTime}
                      onChange={(e) => handleChange(index, 'endTime', e.target.value)}
                    />
                  </div>
                </div>
                
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Docente</label>
                    <input
                      type="text"
                      className="form-input"
                      value={session.docente}
                      onChange={(e) => handleChange(index, 'docente', e.target.value)}
                    />
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Aula</label>
                    <input
                      type="text"
                      className="form-input"
                      value={session.aula}
                      onChange={(e) => handleChange(index, 'aula', e.target.value)}
                    />
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Comisi√≥n</label>
                    <input
                      type="text"
                      className="form-input"
                      value={session.numeroComision}
                      onChange={(e) => handleChange(index, 'numeroComision', e.target.value)}
                    />
                  </div>
                </div>
                
                <div className="form-group">
                  <label>
                    <input
                      type="checkbox"
                      className="form-checkbox"
                      checked={session.obligatoria}
                      onChange={(e) => handleChange(index, 'obligatoria', e.target.checked)}
                    />
                    Asistencia obligatoria
                  </label>
                </div>
                
                <button className="btn btn-danger btn-sm" onClick={() => handleRemove(index)}>
                  Eliminar sesi√≥n
                </button>
              </div>
            ))}
          </div>
          
          <button className="btn btn-secondary" onClick={handleAdd} style={{ marginTop: '1rem' }}>
            + Agregar cursada semanal
          </button>
        </div>
      );
    }

    function EventsStep({ events, courses, onChange }) {
      const handleAdd = () => {
        onChange([...events, createEmptyEvent()]);
      };

      const handleRemove = (index) => {
        onChange(events.filter((_, i) => i !== index));
      };

      const handleChange = (index, field, value) => {
        const updated = [...events];
        updated[index] = { ...updated[index], [field]: value };
        // Si cambia el tipo de examen y no es "Otro", limpiar customExamType
        if (field === 'examType' && value !== 'Otro') {
          updated[index].customExamType = '';
        }
        onChange(updated);
      };

      const examTypes = [
        '1er Parcial',
        '2do Parcial',
        'Parcial Integrador',
        'Rec 1er Parcial',
        'Rec 2do Parcial',
        'Habilitante',
        'Otro'
      ];

      return (
        <div>
          <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
            {events.map((event, index) => (
              <div key={event.id} style={{ marginBottom: '1.5rem', padding: '1rem', background: 'var(--background)', borderRadius: '8px' }}>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Materia</label>
                    <select
                      className="form-select"
                      value={event.courseId}
                      onChange={(e) => handleChange(index, 'courseId', e.target.value)}
                    >
                      <option value="">Seleccionar...</option>
                      {courses.map(c => (
                        <option key={c.id} value={c.id}>{c.nombre}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Tipo</label>
                    <select
                      className="form-select"
                      value={event.eventualType}
                      onChange={(e) => handleChange(index, 'eventualType', e.target.value)}
                    >
                      <option value="examen">Examen</option>
                      <option value="entrega">Entrega</option>
                      <option value="otro">Otro</option>
                    </select>
                  </div>
                </div>
                
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Tipo de examen/entrega</label>
                    <select
                      className="form-select"
                      value={event.examType || ''}
                      onChange={(e) => handleChange(index, 'examType', e.target.value)}
                    >
                      <option value="">Seleccionar...</option>
                      {examTypes.map(type => (
                        <option key={type} value={type}>{type}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div className="form-group">
                    <label className="form-label">Fecha</label>
                    <input
                      type="date"
                      className="form-input"
                      value={event.dateISO ? event.dateISO.split('T')[0] : ''}
                      onChange={(e) => handleChange(index, 'dateISO', new Date(e.target.value).toISOString())}
                    />
                  </div>
                </div>
                
                {event.examType === 'Otro' && (
                  <div className="form-group">
                    <label className="form-label">Especificar tipo de examen/entrega</label>
                    <input
                      type="text"
                      className="form-input"
                      value={event.customExamType || ''}
                      onChange={(e) => handleChange(index, 'customExamType', e.target.value)}
                      placeholder="Ej: Coloquio, Evaluaci√≥n oral, etc."
                    />
                  </div>
                )}
                
                <div className="form-group">
                  <label className="form-label">Notas</label>
                  <textarea
                    className="form-textarea"
                    value={event.notes}
                    onChange={(e) => handleChange(index, 'notes', e.target.value)}
                    placeholder="Informaci√≥n adicional..."
                  />
                </div>
                
                <button className="btn btn-danger btn-sm" onClick={() => handleRemove(index)}>
                  Eliminar evento
                </button>
              </div>
            ))}
          </div>
          
          <button className="btn btn-secondary" onClick={handleAdd} style={{ marginTop: '1rem' }}>
            + Agregar examen/entrega
          </button>
        </div>
      );
    }

    // ============ PANEL LATERAL ============
    
    function SidePanel({ item, courses, sessions, events, onClose, onEdit, onDelete }) {
      if (!item || !item.type) return null;

      const handleOverlayClick = (e) => {
        // Solo cerrar si el click es directamente en el overlay, no en sus hijos
        if (e.target === e.currentTarget) {
          onClose();
        }
      };

      // Renderizar panel para actividades extracurriculares
      if (item.type === 'extra') {
        const activity = item;
        return (
          <>
            <div 
              className="modal-overlay" 
              onClick={handleOverlayClick}
              onWheel={(e) => e.stopPropagation()}
              style={{ background: 'rgba(0,0,0,0.3)' }}
            />
            <div className="side-panel open">
              <div className="side-panel-header">
                <h2 className="modal-title">
                  <span style={{ marginRight: '0.5rem' }}>{getActivityIcon(activity.kind)}</span>
                  {getActivityTitle(activity)}
                </h2>
                <button className="modal-close" onClick={onClose}>√ó</button>
              </div>
              
              <div className="side-panel-body">
                <div className="side-panel-section">
                  <div className="side-panel-section-title">Horario</div>
                  <p>{getDayName(activity.dayOfWeek)} ‚Ä¢ {formatTime(activity.startTime)} - {formatTime(activity.endTime)}</p>
                  {activity.startDate && (
                    <p style={{ fontSize: '0.9rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>
                      Desde: {new Date(activity.startDate + 'T00:00:00').toLocaleDateString('es-AR')}
                    </p>
                  )}
                </div>
                
                {/* Botones de acci√≥n */}
                <div className="side-panel-section">
                  <div style={{ display: 'flex', gap: '0.75rem' }}>
                    <button 
                      className="btn btn-secondary btn-sm" 
                      onClick={() => {
                        onClose();
                        onEdit(activity);
                      }}
                      style={{ flex: 1 }}
                    >
                      ‚úèÔ∏è Editar
                    </button>
                    <button 
                      className="btn btn-danger btn-sm" 
                      onClick={() => {
                        if (confirm('¬øEst√° seguro de eliminar esta actividad?')) {
                          onDelete(activity.id);
                          onClose();
                        }
                      }}
                      style={{ flex: 1 }}
                    >
                      üóëÔ∏è Eliminar
                    </button>
                  </div>
                </div>
                
                {activity.kind === 'gym' && activity.metadata.muscleGroups && activity.metadata.muscleGroups.length > 0 && (
                  <div className="side-panel-section">
                    <div className="side-panel-section-title">Grupos musculares</div>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                      {activity.metadata.muscleGroups.map(group => (
                        <span key={group} style={{ padding: '0.25rem 0.75rem', background: 'var(--background)', borderRadius: '12px', fontSize: '0.9rem' }}>
                          {group}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
                
                {activity.kind === 'tenis' && activity.metadata.intensity && (
                  <div className="side-panel-section">
                    <div className="side-panel-section-title">Intensidad</div>
                    <p>{activity.metadata.intensity}</p>
                  </div>
                )}
                
                {activity.kind === 'clase_tenis' && (
                  <>
                    {activity.metadata.studentLevel && (
                      <div className="side-panel-section">
                        <div className="side-panel-section-title">Nivel alumnos</div>
                        <p>{activity.metadata.studentLevel}</p>
                      </div>
                    )}
                    {activity.metadata.modality && (
                      <div className="side-panel-section">
                        <div className="side-panel-section-title">Modalidad</div>
                        <p>
                          {activity.metadata.modality}
                          {activity.metadata.modality === 'Grupal' && activity.metadata.studentCount && 
                            ` (${activity.metadata.studentCount} alumnos)`
                          }
                        </p>
                      </div>
                    )}
                  </>
                )}
                
                {activity.kind === 'otra' && activity.metadata.otherDescription && (
                  <div className="side-panel-section">
                    <div className="side-panel-section-title">Descripci√≥n</div>
                    <p>{activity.metadata.otherDescription}</p>
                  </div>
                )}
                
                {activity.metadata.note && (
                  <div className="side-panel-section">
                    <div className="side-panel-section-title">Notas</div>
                    <p>{activity.metadata.note}</p>
                  </div>
                )}
              </div>
            </div>
          </>
        );
      }

      // Renderizar panel para cursos (c√≥digo original)
      const course = item.type === 'course' ? item : courses.find(c => c.id === item.courseId);
      const courseSessions = sessions.filter(s => s.courseId === course?.id);
      const courseEvents = events.filter(e => e.courseId === course?.id);

      return (
        <>
          <div 
            className="modal-overlay" 
            onClick={handleOverlayClick}
            onWheel={(e) => e.stopPropagation()}
            style={{ background: 'rgba(0,0,0,0.3)' }}
          />
          <div className="side-panel open">
            <div className="side-panel-header">
              <h2 className="modal-title">{course?.nombre}</h2>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            
            <div className="side-panel-body">
              {course?.email && (
                <div className="side-panel-section">
                  <div className="side-panel-section-title">Contacto</div>
                  <p>{course.email}</p>
                </div>
              )}
              
              {course?.notas && (
                <div className="side-panel-section">
                  <div className="side-panel-section-title">Notas</div>
                  <p>{course.notas}</p>
                </div>
              )}
              
              {courseSessions.length > 0 && (
                <div className="side-panel-section">
                  <div className="side-panel-section-title">Cursadas semanales</div>
                  {courseSessions.map(session => (
                    <div key={session.id} style={{ marginBottom: '1rem', padding: '0.75rem', background: 'var(--background)', borderRadius: '6px' }}>
                      <div style={{ fontWeight: 600, textTransform: 'capitalize', marginBottom: '0.5rem' }}>
                        {session.modalidad}
                      </div>
                      <div style={{ fontSize: '0.9rem', color: 'var(--text-muted)' }}>
                        {getDayName(session.dayOfWeek)} ‚Ä¢ {formatTime(session.startTime)} - {formatTime(session.endTime)}
                        {session.aula && ` ‚Ä¢ ${session.aula}`}
                        {session.docente && (
                          <div style={{ marginTop: '0.25rem' }}>
                            Docente: {session.docente}
                          </div>
                        )}
                        {session.numeroComision && (
                          <div style={{ marginTop: '0.25rem' }}>
                            {session.numeroComision}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
              
              {courseEvents.length > 0 && (
                <div className="side-panel-section">
                  <div className="side-panel-section-title">Ex√°menes y entregas</div>
                  {courseEvents.map(event => (
                    <div key={event.id} style={{ marginBottom: '1rem', padding: '0.75rem', background: 'var(--background)', borderRadius: '6px' }}>
                      <div style={{ fontWeight: 600, marginBottom: '0.5rem' }}>
                        {getExamTypeName(event)}
                      </div>
                      <div style={{ fontSize: '0.9rem', color: 'var(--text-muted)' }}>
                        {new Date(event.dateISO).toLocaleDateString('es-AR', {
                          weekday: 'long',
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric'
                        })}
                        {event.notes && (
                          <div style={{ marginTop: '0.5rem' }}>
                            {event.notes}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </>
      );
    }

    // ============ RENDER ============
    
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>